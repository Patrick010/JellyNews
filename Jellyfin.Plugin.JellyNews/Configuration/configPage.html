<!DOCTYPE html>
<html>

<head>
    <title>JellyNews</title>
</head>

<body>
    <div id="JellyNewsConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
        data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="JellyNewsConfigForm">

                    <div class="selectContainer">
                        <label class="selectLabel" for="selectLoggingLevel">Log Level</label>
                        <select is="emby-select" id="selectLoggingLevel" name="selectLoggingLevel"
                            class="emby-select-withcolor emby-select">
                            <option value="Trace">Trace</option>
                            <option value="Debug">Debug</option>
                            <option value="Information">Information</option>
                            <option value="Warning">Warning</option>
                            <option value="Error">Error</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>

                    <br />
                    <br />

                    <div id="librarySelection">
                        <h2>Select Libraries to Scan</h2>
                    </div>

                    <br />

                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            var JellyNewsConfig = {
                pluginUniqueId: 'a7757465-2526-45fb-99c1-6464949dc189'
            };

            function loadConfig(page) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(JellyNewsConfig.pluginUniqueId).then(function (config) {

                    // Create library checkboxes
                    if (config.AvailableLibraries) {
                        var librarySelection = document.querySelector('#librarySelection');
                        config.AvailableLibraries.forEach(function (library) {
                            var checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = library.Id;
                            checkbox.name = 'selectedLibraries';
                            checkbox.value = library.Id;
                            checkbox.checked = config.SelectedLibraryIds.includes(library.Id);

                            var label = document.createElement('label');
                            label.htmlFor = library.Id;
                            label.appendChild(document.createTextNode(library.Name + ' (' + library.ContentType + ')'));

                            var container = document.createElement('div');
                            container.appendChild(checkbox);
                            container.appendChild(label);
                            librarySelection.appendChild(container);
                        });
                    }

                    // Set log level
                    page.querySelector('#selectLoggingLevel').value = config.LoggingLevel;

                    Dashboard.hideLoadingMsg();
                });
            }

            document.querySelector('#JellyNewsConfigPage').addEventListener('pageshow', function () {
                loadConfig(this);
            });

            document.querySelector('#JellyNewsConfigForm').addEventListener('submit', function (e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(JellyNewsConfig.pluginUniqueId).then(function (config) {

                    // Save selected libraries
                    var selectedLibraries = [];
                    var checkboxes = document.querySelectorAll('input[name="selectedLibraries"]:checked');
                    for (var i = 0; i < checkboxes.length; i++) {
                        selectedLibraries.push(checkboxes[i].value);
                    }
                    config.SelectedLibraryIds = selectedLibraries;

                    // Save log level
                    config.LoggingLevel = document.querySelector('#selectLoggingLevel').value;

                    ApiClient.updatePluginConfiguration(JellyNewsConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });
                });
                return false;
            });

        </script>
    </div>
</body>

</html>
