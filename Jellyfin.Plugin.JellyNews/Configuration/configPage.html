<!DOCTYPE html>
<html>

<head>
    <title>JellyNews</title>
</head>

<body>
    <div id="JellyNewsConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
        data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="JellyNewsConfigForm">

                    <div id="librarySelection">
                        <h2>Select Libraries to Scan</h2>
                    </div>

                    <div class="selectContainer">
                        <label for="selectLogLevel">Log Level:</label>
                        <select id="selectLogLevel" is="emby-select" name="selectLogLevel">
                            <option value="0">Trace</option>
                            <option value="1">Debug</option>
                            <option value="2">Information</option>
                            <option value="3">Warning</option>
                            <option value="4">Error</option>
                            <option value="5">Critical</option>
                        </select>
                    </div>

                    <br />

                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>

            </div>
        </div>

        <script>
            var JellyNewsConfig = {
                pluginUniqueId: 'a7757465-2526-45fb-99c1-6464949dc189'
            };

            let currentConfig;

            function loadConfig(page) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(JellyNewsConfig.pluginUniqueId).then(function (config) {
                    currentConfig = config;
                    // Create library checkboxes
                    if (config.AvailableLibraries) {
                        var librarySelection = document.querySelector('#librarySelection');
                        librarySelection.innerHTML = '';
                        config.AvailableLibraries.forEach(function (library) {
                            var checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = library.Id;
                            checkbox.name = 'selectedLibraries';
                            checkbox.value = library.Id;
                            checkbox.checked = library.Selected;
                            checkbox.dataset.id = library.Id;
                            checkbox.dataset.name = library.Name;
                            checkbox.dataset.contentType = library.ContentType;
                            checkbox.classList.add('library-checkbox');

                            var label = document.createElement('label');
                            label.htmlFor = library.Id;
                            label.appendChild(document.createTextNode(library.Name + ' (' + library.ContentType + ')'));

                            var container = document.createElement('div');
                            container.appendChild(checkbox);
                            container.appendChild(label);
                            librarySelection.appendChild(container);
                        });
                    }

                    // Set log level
                    page.querySelector('#selectLogLevel').value = config.LogLevel;

                    Dashboard.hideLoadingMsg();
                });
            }

            document.querySelector('#JellyNewsConfigPage').addEventListener('pageshow', function () {
                loadConfig(this);
            });

            document.querySelector('#JellyNewsConfigForm').addEventListener('submit', function (e) {
                e.preventDefault();

                // Rebuild the full library list from checkboxes
                const libs = [];
                document.querySelectorAll(".library-checkbox").forEach(el => {
                    libs.push({
                        Id: el.dataset.id,
                        Name: el.dataset.name,
                        ContentType: el.dataset.contentType,
                        Selected: el.checked
                    });
                });

                currentConfig.AvailableLibraries = libs;

                // Save log level
                currentConfig.LogLevel = document.querySelector('#selectLogLevel').value;

                Dashboard.showLoadingMsg();
                ApiClient.updatePluginConfiguration(JellyNewsConfig.pluginUniqueId, currentConfig).then(function (result) {
                    Dashboard.hideLoadingMsg();
                    Dashboard.processPluginConfigurationUpdateResult(result);
                });

                return false;
            });

        </script>
    </div>
</body>

</html>
